(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.CanvasFreeDrawing=b()})(this,function(){"use strict";function a(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},d=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),e=function(){function e(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};b(this,e);var c=a.elementId,d=void 0===c?this.requiredParam("elementId"):c,f=a.width,g=void 0===f?this.requiredParam("width"):f,h=a.height,i=void 0===h?this.requiredParam("height"):h,j=a.backgroundColor,k=void 0===j?[255,255,255]:j,l=a.lineWidth,m=a.strokeColor,n=a.disabled;this.elementId=d,this.canvas=document.getElementById(this.elementId),this.checkCanvasElement(),this.context=this.canvas.getContext("2d",{alpha:!1}),this.width=g,this.height=i,this.lastPath=null,this.positions=[],this.leftCanvasDrawing=!1,this.isDrawing=!1,this.isDrawingModeEnabled=!0,this.imageRestored=!1,this.lineWidth=l||5,this.strokeColor=this.validateColor(m,!0),this.bucketToolColor=this.validateColor(m,!0),this.bucketToolTolerance=0,this.isBucketToolEnabled=!1,this.allowedEvents=["redraw","mouseup","mousedown","mouseenter","mouseleave"],this.redrawCounter=0,this.dispatchEventsOnceEvery=0,this.redrawEvent=new Event("cfd_redraw"),this.mouseUpEvent=new Event("cfd_mouseup"),this.mouseDownEvent=new Event("cfd_mousedown"),this.mouseEnterEvent=new Event("cfd_mouseenter"),this.mouseLeaveEvent=new Event("cfd_mouseleave"),this.mouseDown=this.mouseDown.bind(this),this.mouseMove=this.mouseMove.bind(this),this.mouseLeave=this.mouseLeave.bind(this),this.mouseUp=this.mouseUp.bind(this),this.mouseUpDocument=this.mouseUpDocument.bind(this),this.setDimensions(),this.setBackground(k),n||this.enableDrawingMode()}return d(e,[{key:"requiredParam",value:function(a){throw new Error(a+" is required")}},{key:"checkCanvasElement",value:function(){if("CANVAS"!==this.canvas.tagName){var a=document.createElement("canvas");this.canvas.appendChild(a),this.canvas=a}}},{key:"addListeners",value:function(){this.canvas.addEventListener("mousedown",this.mouseDown),this.canvas.addEventListener("mousemove",this.mouseMove),this.canvas.addEventListener("mouseleave",this.mouseLeave),this.canvas.addEventListener("mouseup",this.mouseUp),document.addEventListener("mouseup",this.mouseUpDocument)}},{key:"removeListeners",value:function(){this.canvas.removeEventListener("mousedown",this.mouseDown),this.canvas.removeEventListener("mouseMove",this.mouseMove),this.canvas.removeEventListener("mouseLeave",this.mouseLeave),this.canvas.removeEventListener("mouseUp",this.mouseUp),document.removeEventListener("mouseUp",this.mouseUpDocument)}},{key:"enableDrawingMode",value:function(){return this.addListeners(),this.toggleCursor(),this.isDrawingModeEnabled=!0,this.isDrawingModeEnabled}},{key:"disableDrawingMode",value:function(){return this.removeListeners(),this.toggleCursor(),this.isDrawingModeEnabled=!1,this.isDrawingModeEnabled}},{key:"mouseDown",value:function(a){if(0===a.button){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;if(this.isBucketToolEnabled)return void this.fill(b,c,this.bucketToolColor,this.bucketToolTolerance);this.isDrawing=!0;var d=this.storeDrawing(b,c,!1);this.lastPath=d-1,this.canvas.dispatchEvent(this.mouseDownEvent),this.redraw()}}},{key:"mouseMove",value:function(a){if(this.leftCanvasDrawing&&(this.leftCanvasDrawing=!1,this.mouseDown(a)),this.isDrawing){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;this.storeDrawing(b,c,!0),this.redraw(!1,this.dispatchEventsOnceEvery)}}},{key:"mouseUp",value:function(){this.isDrawing=!1,this.canvas.dispatchEvent(this.mouseUpEvent)}},{key:"mouseUpDocument",value:function(){this.leftCanvasDrawing=!1}},{key:"mouseLeave",value:function(){this.isDrawing&&(this.leftCanvasDrawing=!0),this.isDrawing=!1,this.canvas.dispatchEvent(this.mouseLeaveEvent)}},{key:"mouseEnter",value:function(){this.canvas.dispatchEvent(this.mouseEnterEvent)}},{key:"toggleCursor",value:function(){this.canvas.style.cursor="crosshair"===this.canvas.style.cursor?"auto":"crosshair"}},{key:"storeDrawing",value:function(a,b,c){return this.positions.push({x:a,y:b,moving:c})}},{key:"redraw",value:function(a,b){var c=this;this.context.strokeStyle=this.rgbaFromArray(this.strokeColor),this.context.lineJoin="round",this.context.lineWidth=this.lineWidth;var d=[];d=a?this.positions:this.positions.slice(this.lastPath),d.forEach(function(a,b){var e=a.x,f=a.y,g=a.moving;c.context.beginPath(),g&&b?c.context.moveTo(d[b-1].x,d[b-1].y):c.context.moveTo(e-1,f),c.context.lineTo(e,f),c.context.closePath(),c.context.stroke()}),b?0==this.redrawCounter%b&&this.canvas.dispatchEvent(this.redrawEvent):this.canvas.dispatchEvent(this.redrawEvent),this.redrawCounter+=1}},{key:"fill",value:function(a,b,c,d){if(0===this.positions.length&&!this.imageRestored)return void this.setBackground(c,!1);var f=this.context.getImageData(0,0,this.width,this.height),g=f.data,h=this.getNodeColor(a,b,g),j=this.getNodeColor(a,b,g);if(!this.isNodeColorEqual(j,c,d)&&this.isNodeColorEqual(h,j)){for(var k=[[a,b]];k.length&&!(k.length>this.width*this.height);){for(var l=k.pop(),m=l,n=l;this.isNodeColorEqual(this.getNodeColor(m[0]-1,m[1],g),j,d);)m=[m[0]-1,m[1]];for(;this.isNodeColorEqual(this.getNodeColor(n[0]+1,n[1],g),j,d);)n=[n[0]+1,n[1]];for(var o=m[0],p=n[0],q=o;q<=p;q++)this.setNodeColor(q,m[1],c,g),this.isNodeColorEqual(this.getNodeColor(q,m[1]+1,g),j,d)&&k.push([q,m[1]+1]),this.isNodeColorEqual(this.getNodeColor(q,m[1]-1,g),j,d)&&k.push([q,m[1]-1])}this.context.putImageData(f,0,0),this.canvas.dispatchEvent(this.redrawEvent)}}},{key:"isNodeColorEqual",value:function(a,b,c){var d=Math.abs;return c?d(b[0]-a[0])<=c&&d(b[1]-a[1])<=c&&d(b[2]-a[2])<=c:a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}},{key:"getNodeColor",value:function(a,b,c){var d=4*(a+b*this.width);return[c[d],c[d+1],c[d+2],c[d+3]]}},{key:"setNodeColor",value:function(a,b,c,d){var e=4*(a+b*this.width);d[e]=c[0],d[e+1]=c[1],d[e+2]=c[2],d[e+3]=c[3]}},{key:"rgbaFromArray",value:function(b){return"rgba("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"}},{key:"rgbFromArray",value:function(b){return"rgb("+b[0]+","+b[1]+","+b[2]+")"}},{key:"setDimensions",value:function(){this.canvas.height=this.height,this.canvas.width=this.width}},{key:"validateColor",value:function(b,d){if("object"===("undefined"==typeof b?"undefined":c(b))&&4===b.length&&b.pop(),"object"===("undefined"==typeof b?"undefined":c(b))&&3===b.length){var e=[].concat(a(b));return e.push(255),e}return d?[0,0,0,255]:(console.warn("Color is not valid! It must be an array with RGB values:  [0-255, 0-255, 0-255]"),null)}},{key:"on",value:function(a,b){var c=a.event,d=void 0===c?this.requiredParam("event"):c,e=a.counter;this.allowedEvents.includes(d)?("redraw"===d&&Number.isInteger(e)&&(this.dispatchEventsOnceEvery=parseInt(e)),this.canvas.addEventListener("cfd_"+d,function(){return b()})):console.warn("This event is not allowed: "+d)}},{key:"setLineWidth",value:function(a){this.lineWidth=a}},{key:"setBackground",value:function(a){var b=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],c=this.validateColor(a);c&&(b&&(this.backgroundColor=c),this.context.fillStyle=this.rgbaFromArray(c),this.context.fillRect(0,0,this.width,this.height))}},{key:"setDrawingColor",value:function(a){this.configBucketTool({color:a}),this.setStrokeColor(a)}},{key:"setStrokeColor",value:function(a){this.strokeColor=this.validateColor(a,!0)}},{key:"configBucketTool",value:function(a){var b=a.color,c=void 0===b?null:b,d=a.tolerance,e=void 0===d?null:d;c&&(this.bucketToolColor=this.validateColor(c)),e&&0<e&&(this.bucketToolTolerance=e)}},{key:"toggleBucketTool",value:function(){return this.isBucketToolEnabled=!this.isBucketToolEnabled}},{key:"isBucketToolEnabled",value:function(){return this.isBucketToolEnabled}},{key:"toggleDrawingMode",value:function(){return this.isDrawingModeEnabled?this.disableDrawingMode():this.enableDrawingMode()}},{key:"isDrawingModeEnabled",value:function(){return this.isDrawingModeEnabled}},{key:"clear",value:function(){this.context.clearRect(0,0,this.width,this.height),this.lastPath=null,this.positions=[],this.isDrawing=!1,this.setBackground(this.backgroundColor)}},{key:"save",value:function(){return this.canvas.toDataURL()}},{key:"restore",value:function(a){var b=this,c=new Image;c.src=a,c.onload=function(){b.imageRestored=!0,b.context.drawImage(c,0,0)}}}]),e}();return e});