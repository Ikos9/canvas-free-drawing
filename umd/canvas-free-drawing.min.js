(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.CanvasFreeDrawing=b()})(this,function(){"use strict";var a=function(){var b=Math.abs;function a(a){this.isNodeColorEqualCache=[];var b=a.elementId,c=a.width,d=a.height,e=a.backgroundColor,f=void 0===e?[255,255,255]:e,g=a.lineWidth,h=void 0===g?5:g,i=a.strokeColor,j=a.disabled,k=a.showWarnings,l=a.maxSnapshots,m=void 0===l?10:l;if(this.requiredParam(a,"elementId"),this.requiredParam(a,"width"),this.requiredParam(a,"height"),this.elementId=b,this.canvasNode=document.getElementById(this.elementId),this.canvasNode instanceof HTMLCanvasElement)this.canvas=this.canvasNode;else if(this.canvasNode instanceof HTMLElement){var n=document.createElement("canvas");this.canvasNode.appendChild(n),this.canvas=n}else throw new Error("No element found with following id: "+this.elementId);this.context=this.canvas.getContext("2d"),this.width=c,this.height=d,this.maxSnapshots=m,this.snapshots=[],this.undos=[],this.positions=[],this.leftCanvasDrawing=!1,this.isDrawing=!1,this.isDrawingModeEnabled=!0,this.imageRestored=!1,this.lineWidth=h,this.strokeColor=this.toValidColor(i),this.bucketToolColor=this.toValidColor(i),this.bucketToolTolerance=0,this.isBucketToolEnabled=!1,this.listenersList=["mouseDown","mouseMove","mouseLeave","mouseUp","touchStart","touchMove","touchEnd"],this.allowedEvents=["redraw","mouseup","mousedown","mouseenter","mouseleave"],this.redrawCounter=0,this.dispatchEventsOnceEvery=0,this.redrawEvent=new Event("cfd_redraw"),this.mouseUpEvent=new Event("cfd_mouseup"),this.mouseDownEvent=new Event("cfd_mousedown"),this.mouseEnterEvent=new Event("cfd_mouseenter"),this.mouseLeaveEvent=new Event("cfd_mouseleave"),this.touchStartEvent=new Event("cfd_touchstart"),this.touchEndEvent=new Event("cfd_touchend"),this.mouseDown=this.mouseDown.bind(this),this.mouseMove=this.mouseMove.bind(this),this.mouseLeave=this.mouseLeave.bind(this),this.mouseUp=this.mouseUp.bind(this),this.mouseUpDocument=this.mouseUpDocument.bind(this),this.touchStart=this.touchStart.bind(this),this.touchMove=this.touchMove.bind(this),this.touchEnd=this.touchEnd.bind(this),this.touchIdentifier=void 0,this.previousX=void 0,this.previousY=void 0,this.showWarnings=void 0!==k&&k,this.isNodeColorEqualCache=[],this.setDimensions(),this.setBackground(f),this.storeSnapshot(),j||this.enableDrawingMode()}return a.prototype.requiredParam=function(a,b){if(!a||!a[b])throw new Error(b+" is required")},a.prototype.logWarning=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];this.showWarnings&&console.warn.apply(console,a)},a.prototype.addListeners=function(){var a=this;this.listenersList.forEach(function(b){a.canvas.addEventListener(b.toLowerCase(),a[b])}),document.addEventListener("mouseup",this.mouseUpDocument)},a.prototype.removeListeners=function(){var a=this;this.listenersList.forEach(function(b){a.canvas.removeEventListener(b.toLowerCase(),a[b])}),document.removeEventListener("mouseup",this.mouseUpDocument)},a.prototype.enableDrawingMode=function(){return this.isDrawingModeEnabled=!0,this.addListeners(),this.toggleCursor(),this.isDrawingModeEnabled},a.prototype.disableDrawingMode=function(){return this.isDrawingModeEnabled=!1,this.removeListeners(),this.toggleCursor(),this.isDrawingModeEnabled},a.prototype.mouseDown=function(a){if(0===a.button){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;return this.drawPoint(b,c)}},a.prototype.mouseMove=function(a){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;this.drawLine(b,c,a)},a.prototype.touchStart=function(a){if(0<a.changedTouches.length){var b=a.changedTouches[0],c=b.pageX,d=b.pageY,e=b.identifier,f=c-this.canvas.offsetLeft,g=d-this.canvas.offsetTop;return this.touchIdentifier=e,this.drawPoint(f,g)}},a.prototype.touchMove=function(a){if(0<a.changedTouches.length){var b=a.changedTouches[0],c=b.pageX,d=b.pageY,e=b.identifier,f=c-this.canvas.offsetLeft,g=d-this.canvas.offsetTop;if(e!=this.touchIdentifier)return;this.previousX=f,this.previousY=g,this.drawLine(f,g,a)}},a.prototype.touchEnd=function(){this.handleEndDrawing(),this.canvas.dispatchEvent(this.touchEndEvent)},a.prototype.mouseUp=function(){this.handleEndDrawing(),this.canvas.dispatchEvent(this.mouseUpEvent)},a.prototype.mouseUpDocument=function(){this.leftCanvasDrawing=!1},a.prototype.mouseLeave=function(){this.isDrawing&&(this.leftCanvasDrawing=!0),this.isDrawing=!1,this.canvas.dispatchEvent(this.mouseLeaveEvent)},a.prototype.mouseEnter=function(){this.canvas.dispatchEvent(this.mouseEnterEvent)},a.prototype.handleEndDrawing=function(){this.isDrawing=!1,this.storeSnapshot()},a.prototype.drawPoint=function(a,b){return this.isBucketToolEnabled?this.fill(a,b,this.bucketToolColor,{tolerance:this.bucketToolTolerance}):void(this.isDrawing=!0,this.storeDrawing(a,b,!1),this.canvas.dispatchEvent(this.mouseDownEvent),this.handleDrawing(this.dispatchEventsOnceEvery))},a.prototype.drawLine=function(a,b,c){this.leftCanvasDrawing&&(this.leftCanvasDrawing=!1,c instanceof MouseEvent?this.mouseDown(c):c instanceof TouchEvent&&this.touchEnd()),this.isDrawing&&(this.storeDrawing(a,b,!0),this.handleDrawing(this.dispatchEventsOnceEvery))},a.prototype.handleDrawing=function(a){var b=this;this.context.lineJoin="round";var c=[this.positions.slice().pop()];c.forEach(function(a){a&&a[0]&&a[0].strokeColor&&(b.context.strokeStyle=b.rgbaFromArray(a[0].strokeColor),b.context.lineWidth=a[0].lineWidth,b.draw(a))}),a?0==this.redrawCounter%a&&this.canvas.dispatchEvent(this.redrawEvent):this.canvas.dispatchEvent(this.redrawEvent),this.undos=[],this.redrawCounter+=1},a.prototype.draw=function(a){var b=this;a.forEach(function(c,d){var e=c.x,f=c.y,g=c.moving;b.context.beginPath(),g&&d?b.context.moveTo(a[d-1].x,a[d-1].y):b.context.moveTo(e-1,f),b.context.lineTo(e,f),b.context.closePath(),b.context.stroke()})},a.prototype.fill=function(a,b,c,d){var f=this,g=d.tolerance;return new Promise(function(d){if(c=f.toValidColor(c),0===f.positions.length&&!f.imageRestored)return f.setBackground(c,!1),void f.canvas.dispatchEvent(f.redrawEvent);var h=f.context.getImageData(0,0,f.width,f.height),j=h.data,k=f.getNodeColor(a,b,j);if(!f.isNodeColorEqual(k,c,g)){for(var l=[[a,b]];l.length&&!(l.length>f.width*f.height);){for(var m=l.pop(),n=m,o=m;f.isNodeColorEqual(f.getNodeColor(n[0]-1,n[1],j),k,g);)n=[n[0]-1,n[1]];for(;f.isNodeColorEqual(f.getNodeColor(o[0]+1,o[1],j),k,g);)o=[o[0]+1,o[1]];for(var p=n[0],q=o[0],r=p;r<=q;r++)f.setNodeColor(r,n[1],c,j),f.isNodeColorEqual(f.getNodeColor(r,n[1]+1,j),k,g)&&l.push([r,n[1]+1]),f.isNodeColorEqual(f.getNodeColor(r,n[1]-1,j),k,g)&&l.push([r,n[1]-1])}f.context.putImageData(h,0,0),f.canvas.dispatchEvent(f.redrawEvent),d(!0)}})},a.prototype.toValidColor=function(a){if(Array.isArray(a)&&4===a.length&&a.pop(),Array.isArray(a)&&3===a.length){var b=a.slice();return b.push(255),b}return this.logWarning("Color is not valid! It must be an array with RGB values:  [0-255, 0-255, 0-255]"),[0,0,0,255]},a.prototype.isNodeColorEqual=function(a,c,d){var e=""+a[0]+a[1]+a[2]+a[3],f=""+c[0]+c[1]+c[2]+c[3],g=e+f+d;if(d=d||0,this.isNodeColorEqualCache.hasOwnProperty(e+f+d))return this.isNodeColorEqualCache[g];var h=b(c[0]-a[0]),i=b(c[1]-a[1]),j=b(c[2]-a[2]),k=d>=100*((h/255+i/255+j/255)/3);return this.isNodeColorEqualCache[g]=k,k},a.prototype.getNodeColor=function(a,b,c){var d=4*(a+b*this.width);return[c[d],c[d+1],c[d+2],c[d+3]]},a.prototype.setNodeColor=function(a,b,c,d){var e=4*(a+b*this.width);d[e]=c[0],d[e+1]=c[1],d[e+2]=c[2],d[e+3]=c[3]},a.prototype.rgbaFromArray=function(b){return"rgba("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"},a.prototype.setDimensions=function(){this.canvas.height=this.height,this.canvas.width=this.width},a.prototype.toggleCursor=function(){this.canvas.style.cursor=this.isDrawingModeEnabled?"crosshair":"auto"},a.prototype.storeDrawing=function(a,b,c){if(c){var d=this.positions.length-1;this.positions[d].push({x:a,y:b,moving:c,lineWidth:this.lineWidth,strokeColor:this.strokeColor,isBucket:!1})}else this.positions.push([{x:a,y:b,isBucket:!1,moving:c,lineWidth:this.lineWidth,strokeColor:this.strokeColor}])},a.prototype.storeSnapshot=function(){var a=this;new Promise(function(c){var d=a.getCanvasSnapshot();a.snapshots.push(d),a.snapshots.length>a.maxSnapshots&&(a.snapshots=a.snapshots.splice(-b(a.maxSnapshots))),c()})},a.prototype.getCanvasSnapshot=function(){return this.context.getImageData(0,0,this.width,this.height)},a.prototype.restoreCanvasSnapshot=function(a){this.context.putImageData(a,0,0)},a.prototype.on=function(a,b){var c=Number.isInteger,d=a.event,e=a.counter;this.requiredParam(a,"event"),this.allowedEvents.includes(d)?("redraw"===d&&e&&c(e)&&(this.dispatchEventsOnceEvery=e),this.canvas.addEventListener("cfd_"+d,function(){return b()})):this.logWarning("This event is not allowed: "+d)},a.prototype.setLineWidth=function(a){this.lineWidth=a},a.prototype.setBackground=function(a,b){void 0===b&&(b=!0);var c=this.toValidColor(a);c&&(b&&(this.backgroundColor=c),this.context.fillStyle=this.rgbaFromArray(c),this.context.fillRect(0,0,this.width,this.height))},a.prototype.setDrawingColor=function(a){this.configBucketTool({color:a}),this.setStrokeColor(a)},a.prototype.setStrokeColor=function(a){this.strokeColor=this.toValidColor(a)},a.prototype.configBucketTool=function(a){var b=a.color,c=void 0===b?null:b,d=a.tolerance,e=void 0===d?null:d;c&&(this.bucketToolColor=this.toValidColor(c)),e&&0<e&&(this.bucketToolTolerance=100<e?100:e)},a.prototype.toggleBucketTool=function(){return this.isBucketToolEnabled=!this.isBucketToolEnabled},a.prototype.toggleDrawingMode=function(){return this.isDrawingModeEnabled?this.disableDrawingMode():this.enableDrawingMode()},a.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height),this.positions=[],this.backgroundColor&&this.setBackground(this.backgroundColor),this.handleEndDrawing()},a.prototype.save=function(){return this.canvas.toDataURL()},a.prototype.restore=function(a,b){var c=this,d=new Image;d.src=a,d.onload=function(){c.imageRestored=!0,c.context.drawImage(d,0,0),"function"==typeof b&&b()}},a.prototype.undo=function(){var a=this.snapshots[this.snapshots.length-1],c=this.snapshots[this.snapshots.length-2];c?(this.restoreCanvasSnapshot(c),this.snapshots.pop(),this.undos.push(a),this.undos=this.undos.splice(-b(this.maxSnapshots))):this.logWarning("There are no more undos left.")},a.prototype.redo=function(){if(0<this.undos.length){var a=this.undos.pop();a&&(this.restoreCanvasSnapshot(a),this.snapshots.push(a),this.snapshots=this.snapshots.splice(-b(this.maxSnapshots)))}else this.logWarning("There are no more redo left.")},a}();return a});