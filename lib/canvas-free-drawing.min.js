"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var CanvasFreeDrawing=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var c=b.elementId,d=void 0===c?this.requiredParam("elementId"):c,e=b.width,f=void 0===e?this.requiredParam("width"):e,g=b.height,h=void 0===g?this.requiredParam("height"):g,i=b.lineWidth,j=b.strokeColor;this.elementId=d,this.canvas=document.getElementById(this.elementId),this.context=this.canvas.getContext("2d",{alpha:!1}),this.width=f,this.height=h,this.isDrawing=!1,this.lineWidth=i||5,this.bucketToolTolerance=0,this.lastPath=null,this.imageRestored=!1,this.positions=[],this.leftCanvasDrawing=!1,this.selectedBucket=!1,this.allowedEvents=["redraw","mouseup","mousedown","mouseenter","mouseleave"],this.isCursorHidden=!1,this.strokeColor=this.validateColor(j,!0),this.bucketToolColor=this.validateColor(j,!0),this.handleCursor(),this.setDimensions(),this.setBackground([255,255,255]),this.addListeners(),this.redrawEvent=new Event("cfd_redraw"),this.mouseUpEvent=new Event("cfd_mouseup"),this.mouseDownEvent=new Event("cfd_mousedown"),this.mouseEnterEvent=new Event("cfd_mouseenter"),this.mouseLeaveEvent=new Event("cfd_mouseleave")}return _createClass(a,[{key:"requiredParam",value:function(a){throw new Error(a+" is required")}},{key:"addListeners",value:function(){var a=this;this.canvas.addEventListener("mousedown",function(b){return a.mouseDown(b)}),this.canvas.addEventListener("mousemove",function(b){return a.mouseMove(b)}),this.canvas.addEventListener("mouseleave",function(){return a.mouseLeave()}),this.canvas.addEventListener("mouseup",function(){return a.mouseUp()}),document.addEventListener("mouseup",function(){return a.mouseUpDocument()})}},{key:"mouseDown",value:function(a){if(console.log("mousedown in"),0===a.button){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;if(this.selectedBucket)return void this.fill(b,c,this.bucketToolColor,this.bucketToolTolerance);this.isDrawing=!0;var d=this.storeDrawing(b,c,!1);this.lastPath=d-1,this.canvas.dispatchEvent(this.mouseDownEvent),this.redraw()}}},{key:"mouseMove",value:function(a){if(this.leftCanvasDrawing&&(this.leftCanvasDrawing=!1,this.mouseDown(a)),this.isDrawing){var b=a.pageX-this.canvas.offsetLeft,c=a.pageY-this.canvas.offsetTop;this.storeDrawing(b,c,!0),this.redraw()}}},{key:"mouseUp",value:function(){this.isDrawing=!1,this.canvas.dispatchEvent(this.mouseUpEvent)}},{key:"mouseUpDocument",value:function(){this.leftCanvasDrawing=!1}},{key:"mouseLeave",value:function(){this.isDrawing&&(this.leftCanvasDrawing=!0),this.isDrawing=!1,this.canvas.dispatchEvent(this.mouseLeaveEvent)}},{key:"mouseEnter",value:function(){console.log("mouse enter"),this.canvas.dispatchEvent(this.mouseEnterEvent)}},{key:"handleCursor",value:function(){this.canvas.style.cursor="crosshair"}},{key:"storeDrawing",value:function(a,b,c){return this.positions.push({x:a,y:b,moving:c})}},{key:"redraw",value:function(a){var b=this;this.context.strokeStyle=this.rgbaFromArray(this.strokeColor),this.context.lineJoin="round",this.context.lineWidth=this.lineWidth;var c=[];c=a?this.positions:this.positions.slice(this.lastPath),c.forEach(function(a,d){var e=a.x,f=a.y,g=a.moving;b.context.beginPath(),g&&d?b.context.moveTo(c[d-1].x,c[d-1].y):b.context.moveTo(e-1,f),b.context.lineTo(e,f),b.context.closePath(),b.context.stroke()}),this.canvas.dispatchEvent(this.redrawEvent)}},{key:"fill",value:function(a,b,c,d){if(console.log("fill color",c),0===this.positions.length&&!this.imageRestored)return void this.setBackground(c,!1);if("object"!=("undefined"==typeof c?"undefined":_typeof(c)))throw new Error("New color must be an array like: [255, 255, 255, 255]");var f=Date.now(),g=this.context.getImageData(0,0,this.width,this.height),h=g.data,j=this.getNodeColor(a,b,h),k=this.getNodeColor(a,b,h);if(!this.isNodeColorEqual(k,c,d)&&this.isNodeColorEqual(j,k)){for(var l=[[a,b]];l.length&&!(l.length>this.width*this.height);){for(var m=l.pop(),n=m,o=m;this.isNodeColorEqual(this.getNodeColor(n[0]-1,n[1],h),k,d);)n=[n[0]-1,n[1]];for(;this.isNodeColorEqual(this.getNodeColor(o[0]+1,o[1],h),k,d);)o=[o[0]+1,o[1]];for(var p=n[0],q=o[0],r=p;r<=q;r++)this.setNodeColor(r,n[1],c,h),this.isNodeColorEqual(this.getNodeColor(r,n[1]+1,h),k,d)&&l.push([r,n[1]+1]),this.isNodeColorEqual(this.getNodeColor(r,n[1]-1,h),k,d)&&l.push([r,n[1]-1])}this.context.putImageData(g,0,0),this.canvas.dispatchEvent(this.redrawEvent),console.log("Execution flood-fill: "+(Date.now()-f)+" ms")}}},{key:"isNodeColorEqual",value:function(a,b,c){var d=Math.abs;return c?d(b[0]-a[0])<=c&&d(b[1]-a[1])<=c&&d(b[2]-a[2])<=c:a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}},{key:"getNodeColor",value:function(a,b,c){var d=4*(a+b*this.width);return[c[d],c[d+1],c[d+2],c[d+3]]}},{key:"setNodeColor",value:function(a,b,c,d){var e=4*(a+b*this.width);d[e]=c[0],d[e+1]=c[1],d[e+2]=c[2],d[e+3]=c[3]}},{key:"rgbaFromArray",value:function(b){return"rgba("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"}},{key:"rgbFromArray",value:function(b){return"rgb("+b[0]+","+b[1]+","+b[2]+")"}},{key:"setDimensions",value:function(){this.canvas.height=this.height,this.canvas.width=this.width}},{key:"validateColor",value:function(a,b){if("object"===("undefined"==typeof a?"undefined":_typeof(a))&&4===a.length&&a.pop(),"object"===("undefined"==typeof a?"undefined":_typeof(a))&&3===a.length){var c=[].concat(_toConsumableArray(a));return c.push(255),c}return b?[0,0,0,255]:(console.warn("Color was not valid!"),null)}},{key:"on",value:function(a,b){this.allowedEvents.includes(a)&&this.canvas.addEventListener("cfd_"+a,function(){return b()})}},{key:"setLineWidth",value:function(a){this.lineWidth=a}},{key:"setBackground",value:function(a){var b=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],c=this.validateColor(a);c&&(b&&(this.backgroundColor=c),this.context.fillStyle=this.rgbaFromArray(c),this.context.fillRect(0,0,this.width,this.height))}},{key:"setDrawingColor",value:function(a){this.setBucketTool({color:a}),this.setStrokeColor(a)}},{key:"setStrokeColor",value:function(a){this.strokeColor=this.validateColor(a,!0)}},{key:"setBucketTool",value:function(a){var b=a.color,c=void 0===b?null:b,d=a.tolerance,e=void 0===d?null:d;c&&(this.bucketToolColor=this.validateColor(c)),e&&0<e&&(this.bucketToolTolerance=e)}},{key:"toggleBucket",value:function(){return this.selectedBucket=!this.selectedBucket}},{key:"isBucketActive",value:function(){return this.selectedBucket}},{key:"clear",value:function(){this.context.clearRect(0,0,this.width,this.height),this.lastPath=null,this.positions=[],this.isDrawing=!1,this.setBackground(this.backgroundColor)}},{key:"save",value:function(){return this.canvas.toDataURL()}},{key:"restore",value:function(a){var b=this,c=new Image;c.src=a,c.onload=function(){b.imageRestored=!0,b.context.drawImage(c,0,0)}}}]),a}();